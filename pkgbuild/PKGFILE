# Maintainer: Vilmar Catafesta <vcatafesta@gmail.com>

pkgname=voidlinuxbr-plymouth-theme
pkgdesc="Plymouth theme for VoidLinuxBR"
pkgver=$(date +%Y%m%d)
pkgrel=$(date +%H%M)
arch=('any')
license=('MIT')
url="https://github.com/voidlinuxbr/${pkgname}"
source=("git+${url}.git")
md5sums=('SKIP')
depends=(plymouth)

# Automatically detect and use the correct install file
if [ -e "${pkgname}.install" ]; then
	install=${pkgname}.install
elif [ -e "pkgbuild.install" ]; then
	install=pkgbuild.install
fi

package() {
	local dirs=("usr" "etc" "opt")
	#   echo "DESTDIR=$DESTDIR"
	#   echo "srcdir=$srcdir"
	#   echo "_pkgsrc=$_pkgsrc"

	for dir in "${dirs[@]}"; do
		if [ -d "${_pkgsrc}/${dir}" ]; then
			cp -a "${_pkgsrc}/${dir}" "$DESTDIR/"
		fi
	done
}

post_install() {
	defaultPlymouthTheme='voidlinuxbr'

	# criar só se NÃO existir
	if [ ! -f /etc/dracut.conf.d/10-plymouth.conf ]; then
		cat >/etc/dracut.conf.d/10-plymouth.conf <<'EOF'
# Enable Plymouth in initramfs
add_dracutmodules+=" plymouth "
EOF
	fi

	# garantir que quiet e splash estejam presentes sem sobrescrever outros parâmetros
	if grep -q '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub; then
		grep -q 'quiet' /etc/default/grub ||
			sed -i 's/^\(GRUB_CMDLINE_LINUX_DEFAULT=".*\)"/\1 quiet"/' /etc/default/grub

		grep -q 'splash' /etc/default/grub ||
			sed -i 's/^\(GRUB_CMDLINE_LINUX_DEFAULT=".*\)"/\1 splash"/' /etc/default/grub
	else
		echo 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"' >>/etc/default/grub
	fi

	if ! plymouth-set-default-theme -R "$defaultPlymouthTheme"; then
		exit 1
	fi

	dracut -f

}
